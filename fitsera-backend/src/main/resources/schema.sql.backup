-- =====================================================
-- FITSERA DATABASE SCHEMA
-- Dress Rental Platform - Complete Schema
-- =====================================================

-- Drop existing tables if they exist (in correct order due to foreign keys)
DROP TABLE IF EXISTS notifications CASCADE;
DROP TABLE IF EXISTS issues CASCADE;
DROP TABLE IF EXISTS reviews CASCADE;
DROP TABLE IF EXISTS orders CASCADE;
DROP TABLE IF EXISTS wishlist_items CASCADE;
DROP TABLE IF EXISTS payment_methods CASCADE;
DROP TABLE IF EXISTS addresses CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS customers CASCADE;
DROP TABLE IF EXISTS accounts CASCADE;

-- =====================================================
-- 1. ACCOUNTS TABLE (Brand/Tenant Accounts)
-- Each brand (e.g., Gucci, Zara, H&M) has an account
-- =====================================================
CREATE TABLE accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    brand_logo TEXT,  -- Base64 or URL
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Index for faster lookups
CREATE INDEX idx_accounts_slug ON accounts(slug);

-- =====================================================
-- 2. CUSTOMERS TABLE (End Users/Customers)
-- People who rent dresses from the platform
-- =====================================================
CREATE TABLE customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    full_name VARCHAR(255),
    phone VARCHAR(50),
    profile_image TEXT,
    date_of_birth TIMESTAMP,
    
    -- Preferences
    preferred_size VARCHAR(50),
    preferred_style VARCHAR(255),
    
    -- Loyalty & Marketing
    loyalty_points INTEGER DEFAULT 0,
    newsletter_subscribed BOOLEAN DEFAULT FALSE,
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Index for faster authentication
CREATE INDEX idx_customers_email ON customers(email);

-- =====================================================
-- 3. ADDRESSES TABLE (Customer Shipping/Billing Addresses)
-- Multiple addresses per customer
-- =====================================================
CREATE TABLE addresses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    
    address_type VARCHAR(50),  -- 'shipping', 'billing', 'both'
    is_default BOOLEAN DEFAULT FALSE,
    
    recipient_name VARCHAR(255),
    phone_number VARCHAR(50),
    
    address_line1 VARCHAR(500) NOT NULL,
    address_line2 VARCHAR(500),
    city VARCHAR(255) NOT NULL,
    state VARCHAR(255) NOT NULL,
    postcode VARCHAR(50) NOT NULL,
    country VARCHAR(255) NOT NULL,
    
    delivery_instructions TEXT,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_addresses_customer_id ON addresses(customer_id);
CREATE INDEX idx_addresses_is_default ON addresses(is_default);

-- =====================================================
-- 4. PAYMENT METHODS TABLE (Customer Payment Options)
-- Multiple payment methods per customer
-- =====================================================
CREATE TABLE payment_methods (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    
    payment_type VARCHAR(50) NOT NULL,  -- 'card', 'paypal', 'bank_account'
    is_default BOOLEAN DEFAULT FALSE,
    
    -- Card details (encrypted/tokenized in production)
    card_type VARCHAR(50),  -- 'visa', 'mastercard', 'amex'
    card_last4 VARCHAR(4),
    card_holder_name VARCHAR(255),
    expiry_month INTEGER,
    expiry_year INTEGER,
    
    -- Payment gateway token (for security - Stripe/PayPal)
    payment_token TEXT,
    
    -- Billing address reference
    billing_address_id UUID,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_payment_methods_customer_id ON payment_methods(customer_id);
CREATE INDEX idx_payment_methods_is_default ON payment_methods(is_default);

-- =====================================================
-- 5. WISHLIST ITEMS TABLE (Customer Saved Products)
-- Products customers want to rent later
-- =====================================================
CREATE TABLE wishlist_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    product_id UUID NOT NULL,
    
    -- Cached product info (for quick display)
    product_title VARCHAR(500),
    product_image TEXT,
    product_price DOUBLE PRECISION,
    product_brand VARCHAR(255),
    account_id UUID,
    
    -- Customer preferences for this item
    preferred_size VARCHAR(50),
    preferred_color VARCHAR(100),
    notes TEXT,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- Ensure one product per customer wishlist
    UNIQUE(customer_id, product_id)
);

-- Indexes
CREATE INDEX idx_wishlist_customer_id ON wishlist_items(customer_id);
CREATE INDEX idx_wishlist_product_id ON wishlist_items(product_id);

-- =====================================================
-- 6. BRAND USERS TABLE (Brand Admins/Staff)
-- Staff members who manage products, orders for their brand
-- =====================================================
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
    email VARCHAR(255) UNIQUE NOT NULL,
    full_name VARCHAR(255),
    password VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL DEFAULT 'STAFF',  -- 'OWNER', 'ADMIN', 'STAFF'
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for faster lookups
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_account_id ON users(account_id);

-- =====================================================
-- 7. PRODUCTS TABLE
-- Dresses and clothing items available for rent
-- =====================================================
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
    sku VARCHAR(100),
    brand VARCHAR(255),
    title VARCHAR(500),
    name VARCHAR(500),  -- Product name
    description TEXT,
    base_price_per_day DOUBLE PRECISION,
    price DOUBLE PRECISION,  -- Legacy field for backward compatibility
    image_url TEXT,  -- Main image (Base64 or URL)
    images TEXT,  -- JSON array of multiple images
    occasion VARCHAR(100),  -- e.g., 'Wedding', 'Cocktail', 'Casual'
    available BOOLEAN DEFAULT TRUE,
    archived BOOLEAN DEFAULT FALSE,
    category VARCHAR(100),  -- e.g., 'Dresses', 'Accessories'
    color VARCHAR(100),
    sizes VARCHAR(500),  -- Comma-separated list: 'XS,S,M,L,XL'
    rating DOUBLE PRECISION DEFAULT 0,
    stock INTEGER DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for faster filtering and search
CREATE INDEX idx_products_account_id ON products(account_id);
CREATE INDEX idx_products_brand ON products(brand);
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_occasion ON products(occasion);
CREATE INDEX idx_products_available ON products(available);
CREATE INDEX idx_products_archived ON products(archived);

-- =====================================================
-- 8. ORDERS TABLE
-- Rental orders placed by customers
-- =====================================================
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,
    account_id UUID REFERENCES accounts(id) ON DELETE SET NULL,
    product_id UUID REFERENCES products(id) ON DELETE SET NULL,
    
    -- Customer information (denormalized for historical records)
    customer_name VARCHAR(255),
    customer_email VARCHAR(255),
    customer_phone VARCHAR(50),
    
    -- Product information (denormalized for historical records)
    product_title VARCHAR(500),
    product_image TEXT,
    product_price DOUBLE PRECISION,
    
    -- Order details
    size VARCHAR(50),
    color VARCHAR(100),
    rental_period VARCHAR(100),  -- e.g., '1 Week', '2 Weeks', '1 Month'
    
    -- Delivery address
    delivery_address TEXT,
    city VARCHAR(255),
    postcode VARCHAR(50),
    state VARCHAR(255),
    country VARCHAR(255),
    
    -- Payment information
    payment_method VARCHAR(100),  -- e.g., 'Credit Card', 'PayPal', 'Debit Card'
    card_last4 VARCHAR(4),  -- Last 4 digits of card (security)
    
    -- Pricing
    subtotal DOUBLE PRECISION,
    delivery_fee DOUBLE PRECISION DEFAULT 0,
    discount DOUBLE PRECISION DEFAULT 0,
    total DOUBLE PRECISION,
    
    -- Order status and tracking
    status VARCHAR(50) DEFAULT 'processing',  -- 'processing', 'shipped', 'delivered', 'returned', 'return_overdue'
    order_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    delivery_date TIMESTAMP,
    return_date TIMESTAMP,
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for faster queries
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_account_id ON orders(account_id);
CREATE INDEX idx_orders_product_id ON orders(product_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_order_date ON orders(order_date);

-- =====================================================
-- 9. REVIEWS TABLE
-- Customer reviews for rented products
-- =====================================================
CREATE TABLE reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID REFERENCES products(id) ON DELETE CASCADE,
    account_id UUID REFERENCES accounts(id) ON DELETE CASCADE,
    order_id UUID REFERENCES orders(id) ON DELETE SET NULL,
    
    -- Review content
    product_title VARCHAR(500),
    customer_name VARCHAR(255),
    customer_email VARCHAR(255),
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    review_title VARCHAR(500),
    comment TEXT,
    verified BOOLEAN DEFAULT TRUE,  -- Verified purchase
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for faster queries
CREATE INDEX idx_reviews_product_id ON reviews(product_id);
CREATE INDEX idx_reviews_account_id ON reviews(account_id);
CREATE INDEX idx_reviews_order_id ON reviews(order_id);
CREATE INDEX idx_reviews_rating ON reviews(rating);

-- =====================================================
-- 10. ISSUES TABLE
-- Customer support tickets and return requests
-- =====================================================
CREATE TABLE issues (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id UUID REFERENCES accounts(id) ON DELETE CASCADE,
    order_id UUID REFERENCES orders(id) ON DELETE SET NULL,
    
    -- Customer information
    customer_name VARCHAR(255),
    customer_email VARCHAR(255),
    
    -- Product information
    product_title VARCHAR(500),
    product_image TEXT,
    
    -- Issue details
    issue_type VARCHAR(100),  -- 'Return Request', 'Damage Report', 'Size Issue', 'Quality Complaint'
    priority VARCHAR(50) DEFAULT 'Medium',  -- 'Low', 'Medium', 'High'
    status VARCHAR(50) DEFAULT 'Open',  -- 'Open', 'In Progress', 'Resolved', 'Closed'
    description TEXT,
    resolution TEXT,  -- Notes on how it was resolved
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for faster queries
CREATE INDEX idx_issues_account_id ON issues(account_id);
CREATE INDEX idx_issues_order_id ON issues(order_id);
CREATE INDEX idx_issues_status ON issues(status);
CREATE INDEX idx_issues_priority ON issues(priority);

-- =====================================================
-- 11. NOTIFICATIONS TABLE
-- Notifications for brand admins/staff
-- =====================================================
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    brand_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Notification content
    product_name VARCHAR(500),
    product_image TEXT,
    price DOUBLE PRECISION,
    customer_name VARCHAR(255),
    status VARCHAR(100),  -- 'New Order', 'Out of Stock', 'Return Request'
    type VARCHAR(50),  -- 'order', 'stock_alert', 'return', 'review'
    read BOOLEAN DEFAULT FALSE,
    
    -- Timestamp
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for faster queries
CREATE INDEX idx_notifications_brand_user_id ON notifications(brand_user_id);
CREATE INDEX idx_notifications_read ON notifications(read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);

-- =====================================================
-- SAMPLE DATA (Optional - for testing)
-- =====================================================

-- Insert sample brand account
INSERT INTO accounts (id, name, slug, created_at, updated_at) 
VALUES 
    ('550e8400-e29b-41d4-a716-446655440000', 'H&M', 'h-and-m', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('550e8400-e29b-41d4-a716-446655440001', 'Zara', 'zara', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('550e8400-e29b-41d4-a716-446655440002', 'Gucci', 'gucci', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

-- Insert sample brand user (admin)
-- Password: 'admin123' (Note: In production, use bcrypt or similar hashing)
INSERT INTO users (id, account_id, email, full_name, password, role, created_at, updated_at)
VALUES 
    ('650e8400-e29b-41d4-a716-446655440000', '550e8400-e29b-41d4-a716-446655440000', 'admin@handm.com', 'H&M Admin', 'admin123', 'OWNER', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

-- =====================================================
-- Note: Triggers are commented out due to Spring Boot SQL parser limitations
-- You can run these manually in Supabase SQL Editor if needed
-- =====================================================

-- Function to update updated_at timestamp
-- CREATE OR REPLACE FUNCTION update_updated_at_column()
-- RETURNS TRIGGER AS $$
-- BEGIN
--     NEW.updated_at = CURRENT_TIMESTAMP;
--     RETURN NEW;
-- END;
-- $$ LANGUAGE plpgsql;

-- Apply triggers to all tables with updated_at
-- CREATE TRIGGER update_accounts_updated_at BEFORE UPDATE ON accounts
--     FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- CREATE TRIGGER update_customers_updated_at BEFORE UPDATE ON customers
--     FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
--     FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- CREATE TRIGGER update_products_updated_at BEFORE UPDATE ON products
--     FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- CREATE TRIGGER update_orders_updated_at BEFORE UPDATE ON orders
--     FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- CREATE TRIGGER update_reviews_updated_at BEFORE UPDATE ON reviews
--     FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- CREATE TRIGGER update_issues_updated_at BEFORE UPDATE ON issues
--     FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =====================================================
-- END OF SCHEMA
-- =====================================================

